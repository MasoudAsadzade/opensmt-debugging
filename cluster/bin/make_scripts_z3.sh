#!/bin/bash


if [[ $# -lt 4 ]]; then
    echo "Usage: $0 <z3> <script-dir> <output-dir> <example1> [<example2> [ ... ] ]";
    exit 1;
fi

zthree=$1; shift
scriptd=$1; shift
outd=`readlink -e $1`; shift

i=0
# How many processes to run in the node
ncpus=10
# Timeout (this is probably in CPU time so if you run multithreaded,
# mutiply the number by the number of threads)
timeout=1000

while [[ $# > 0 ]]; do
    ex=$1;
    bname=`basename $ex`
    scrname=`printf "z3.%s.sh" ${bname}`
    echo $scrname
    cat << __EOF__ > $scriptd/$scrname
#!/bin/bash
## Generated by $0
## From $ex
#SBATCH --time=00:30:00
#SBATCH --nodes=1
#SBATCH --exclusive
#SBATCH --mem=0
#SBATCH --output=$outd/$scrname.out
#SBATCH --error=$outd/$scrname.err

osmt_time=$outd/$scrname.osmt
output=$outd/$scrname

script=${zthree}
__EOF__

    for ((i=0; i < $ncpus; i++)); do
        if [[ $# == 0 ]]; then
            break;
        fi
        ex=$1; shift
        cat << __EOF__ >> $scriptd/$scrname
 (
  echo $ex;
  inp=/tmp/\$(basename \${script})-`basename $ex .bz2`;
  bunzip2 -c $ex > \${inp};
  sh -c "ulimit -St ${timeout};
  ulimit -Sv 4000000;
  /usr/bin/time -o \${osmt_time}.${i}.time -f 'user: %U system: %S wall: %e CPU: %PCPU' \$script \$config \$inp" || true; rm \${inp};
 ) > \$output.${i}.out 2> \$output.${i}.err &
__EOF__
    done
    echo "wait" >> $scriptd/$scrname
    i=$((i+1))
    chmod +x $scriptd/$scrname
done
